console.log('CBC2CRM Script Execution Starts...');
function invokeSuccessFunctionForC2C() {
	localStorage.setItem('c2cPreReqDone', 'true');
	if (window.c2cCustomerSegment != null && window.c2cCustomerSegment != 'null' && window.c2cCustomerSegment != 'XXX') {
		console.log('NO RM, c2cCustomerSegment C2C: ' + window.c2cCustomerSegment);
     	successFunction();			
	} else{
		console.log('NO RM & NO CBC2C');
	}
}

function successFunction() {
	 console.log('clicktochat successFunction');
	 if (window.c2cEnableMoxtraTokenCall != null && window.c2cEnableMoxtraTokenCall != 'null' && window.c2cEnableMoxtraTokenCall === 'true') {
		 loadJs(nfsContextPath + '/js/' + window.c2cRMMoxtraJS);
	 }
	 loadStacyComponent();
}

var loadJs = function(url, onLoad, onError) {
	    var newScript = document.createElement('script');
	    if (onError) {
	        newScript.onerror = function() {
	            onError();
	        };
	    }
	    if (onLoad) {
	        newScript.onload = function() {
	            onLoad();
	        };
	    }
	    document.head.appendChild(newScript);
	    newScript.src = url;
};

var loadStacyConfig = function() {
   loadJs(nfsContextPath + '/js/clicktochatconfig.js');   
}

var loadMep = function() {
    loadJs(c2cDomainNameJs + '/vnv/api/mxchat-hk/api/js/moxtra-latest.js');
    loadJs(c2cDomainNameJs + '/vnv/api/mxchat-hk/scb/js/mep.js', loadStacyConfig);
}

var loadStacyComponent = function() {
   loadJs(nfsContextPath + '/js/clicktochat.component.js', loadMep);
}

var c2cPreReqDone;
if (window.localStorage) {
	c2cPreReqDone = localStorage.getItem('c2cPreReqDone');
}

if (c2cPreReqDone == null || c2cPreReqDone == 'null') {
	console.log('click2RM c2cPreReqDone null');
	window.localStorage.removeItem('cnkChatMode');
	window.localStorage.removeItem('cnkRMChatToken');
	window.localStorage.removeItem('cnkWindowFrameState');
	window.localStorage.removeItem('cnkRMHasUnreadMsg');
	window.localStorage.removeItem('cnkUniq');
	window.localStorage.removeItem('cnkMxtFirstInitDone');
	window.localStorage.removeItem('cnkLBHasUnreadMsg');
	window.localStorage.removeItem('cnkBotLanguage');
	window.localStorage.removeItem('c2cNfsVars');
	window.localStorage.removeItem('c2rmAccessTokenCore');

	window.c2cJustLogin = true;
		
	if(window.c2RMEnabled != null && window.c2RMEnabled != 'null' && window.c2RMEnabled != false && window.c2RMEnabled != 'false'){
		$.ajax({
			type: "GET",
			url: nfsContextPath + "/ibank/live_chat_details_link.htm?a=doGetCBC2CRMInfo",
			contentType: "application/json",
			dataType: "json",
			success: function(data){
				if (data.c2cCustomerSegment == null || data.c2cCustomerSegment == 'null') {
					console.log('EXCEPTION, data null');
					invokeSuccessFunctionForC2C();
				} else if (data.c2cCustomerSegment != 'XXX') {
					  if (window.c2cEnableMoxtraTokenCall === true || window.c2cEnableMoxtraTokenCall === 'true') {
					      data.c2cCustomerSegment='SBR';
					  } else {
						  // NOT UPDATING THE VALUE. KEEPING THE c2cCustomerSegment VALUE AS IT IS
				      }
					  console.log('c2cCustomerSegment: ' + data.c2cCustomerSegment);
					  window.moxtraLang = data.rmLang;
					  window.c2cCustomerSegment = data.c2cCustomerSegment;
					  window.c2cRelId = data.c2rmRelID;
					  window.c2cTandCVersion = data.rmTCVersion;
					  window.c2cRMAccessToken = data.rmAccessToken;
					  window.c2cRMUnreadFlag = data.moxtraUnreadCall;
					  localStorage.setItem('c2cPreReqDone', 'true');
					  localStorage.setItem('c2rmAccessTokenCore', data.rmAccessToken);                                              
			     	  successFunction();
				} else {
					if (window.c2cEnableMoxtraTokenCall === true || window.c2cEnableMoxtraTokenCall === 'true') {
					  data.c2cCustomerSegment='SRX';
					  console.log('c2cCustomerSegment else condition: ' + data.c2cCustomerSegment);
					  window.moxtraLang = data.rmLang;
					  window.c2cCustomerSegment = data.c2cCustomerSegment;
					  window.c2cRelId = data.c2rmRelID;
					  window.c2cTandCVersion = data.rmTCVersion;
					  window.c2cRMAccessToken = data.rmAccessToken;
					  window.c2cRMUnreadFlag = data.moxtraUnreadCall;
					  localStorage.setItem('c2cPreReqDone', 'true');
					  localStorage.setItem('c2rmAccessTokenCore', data.rmAccessToken);                                              
			     	  successFunction();
					} else {
                      //NOT UPDATING THE VALUE. KEEPING THE c2cCustomerSegment VALUE AS IT IS
			        }
				}
			  },
			error : function(){
				console.log('EXCEPTION');
				invokeSuccessFunctionForC2C();
			  }
		  });
	} else{
		invokeSuccessFunctionForC2C();		
	}
} else{
	console.log('click2RM c2cPreReqDone not null');
	var nfsVars= JSON.parse(window.localStorage.getItem('c2cNfsVars'));
	if (nfsVars != null && nfsVars != 'null' && nfsVars.c2cCustomerSegment != null 
			&& nfsVars.c2cCustomerSegment != 'null' && nfsVars.c2cCustomerSegment != 'XXX') {
		window.c2cRMAccessToken = localStorage.getItem('c2rmAccessTokenCore');
		successFunction();
	} else{
		console.log('Stacy disabled...');
	}
}
